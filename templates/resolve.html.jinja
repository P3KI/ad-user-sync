
{% macro dict_table(data) %}
  <table>
      {% for key, value in data.items() | rejectattr(1, 'none') %}
        <tr>
          <td>{{ key }}</td>
          <td>
            {% if value is mapping %}
              {{ dict_table(value, show_none) }}
            {% else %}
              {{ value }}
            {% endif %}
          </td>
        </tr>
      {% endfor %}
  </table>
{% endmacro %}

{% set type_descriptions = {
    'enable': 'Enable User',
    'disable': 'Disable User',
    'join': 'Join Group',
    'leave': 'Leave Group',
    'name': 'Account Name Conflict',
} %}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>UserSync</title>
    <link rel="stylesheet" href="static/normalize.css">
    <link rel="icon" type="image/x-icon" href="static/favicon.ico">
    <style>
        :root {
            --cell-padding: 6px;
            --table-border-width: 1px;
        }

        body {
            font-family: monospace;
        }

        /* table */
        table, tr {
            width: 100%;
            border: none;
            border-collapse: collapse;
        }
        td {
            border: var(--table-border-width) solid black;
            padding: var(--cell-padding);
            overflow: hidden;
        }
        td:first-child {
            width: 1px;
            white-space: nowrap;
        }

        /* nested table */
        td > table {
            margin: calc(var(--cell-padding) * -1 - 1px);
            width: calc(100% + 14px);
        }
        td > table td {
            border-color: lightgray;
        }

        /* custom classes */
        #container {
            max-width: 800px;
            margin: 30px auto;
        }
        #title {
            margin-bottom: 0;
        }

        .action-type {
            font-weight: bold;
            border: none;
            padding-top: 1.5em;
        }
        .action-type-0 {
            padding-top: 0;
        }
        .accept-reject-buttons:not(:first-child) {
            margin-top: var(--cell-padding);
        }
        .password-input, .new-name-input {
            width: 350px;
        }
        .success { color: green; }
        .warning { color: orange; }
        .error { color: red; }
        .hidden { display: none; }
    </style>
</head>
<body>
    <div id="container">
    <h1 id="title">P3KI UserSync</h1>
    <div id="state" class="success">interactive session running</div>

    <div class="running-only">
        <span id="actions-count">{{ actions | length }}</span> interaction(s) required
    </div>
    <div class="running-only">
        <span id="passwords-count">{{ password_count }}</span> new password(s) set
        <span id="passwords-unexported" class="warning"></span>
        <a id="passwords-export" href="/export-passwords?tag={{ tag }}" class="hidden">export</a>
    </div>

    {% if error %}
        <h3 class="running-only">Error</h3>
        <pre class="running-only error">{{ error }}</pre>
    {% endif %}


    {% if actions | length > 0 %}
        <h2 class="running-only active-only">Required Interactions</h2>
        <table class="running-only active-only">
            {% for action in actions %}
                {% set action_id = loop.index0 %}
                <form
                    id="{{ action_id }}"
                    action-type="{{ action.type }}"
                    class="action-form"
                    method="post"
                >
                    <input id="{{ action_id }}.tab-id" type="hidden" name="tab_id" value="{{ tab_id }}" />
                    {# type independent action attributes #}
                    <tr>
                        <td class="action-type action-type-{{ action_id }}" colspan="2">
                            {{ type_descriptions[action.type] }}
                            <input id="{{ action_id }}.type" type="hidden" name="type" value="{{ action.type }}" />
                        </td>
                    </tr>
                    <tr>
                        <td>User</td>
                        <td>
                            {{ action.user }}
                            <input id="{{ action_id }}.user" type="hidden" name="user" value="{{ action.user }}" />
                        </td>
                    </tr>

                    {# type dependent action attributes #}
                    {% if action.type == 'join' %}
                        <tr>
                            <td>Group</td>
                            <td>
                                {{ action.group }}
                                <input id="{{ action_id }}.group" type="hidden" name="group" value="{{ action.group }}" />
                            </td>
                        </tr>
                    {% elif action.type == 'leave' %}
                        <tr>
                            <td>Group</td>
                            <td>
                                {{ action.group }}
                                <input id="{{ action_id }}.group" type="hidden" name="group" value="{{ action.group }}" />
                            </td>
                        </tr>
                    {% elif action.type == 'name' %}
                        <tr>
                            <td>User Attributes</td>
                            <td>{{ dict_table(action.attributes) }}</td>
                        </tr>
                        <tr>
                            <td>Conflict User</td>
                            <td>{{ action.conflict_user }}</td>
                        </tr>
                        <tr>
                            <td>Conflicting Account Name</td>
                            <td>
                                {{ action.name }}
                                <input id="{{ action_id }}.name" type="hidden" name="name" value="{{ action.name }}" />
                            </td>
                        </tr>
                    {% endif %}

                    {# action error #}
                    {% if action.error %}
                        <tr>
                            <td>Previous Error</td>
                            <td class="error">{{ action.error }}</td>
                        </tr>
                    {% endif %}

                    {# interaction #}
                    <tr>
                        <td>Action</td>
                        <td>

                            {# type dependent fields #}
                            {% if action.type == 'enable' %}

                                <label for="{{ action_id }}.password">Password</label>
                                <input
                                    id="{{ action_id }}.password"
                                    class="password-input"
                                    type="password"
                                    name="password"
                                    autocomplete="off"
                                />
                                <button
                                    id="{{ action_id }}.show"
                                    class="password-show-button"
                                    type="button"
                                >üëÅ</button>
                                <button
                                    id="{{ action_id }}.generate"
                                    class="password-generate-button"
                                    type="button"
                                >üóò</button>

                            {% elif action.type == 'name' %}

                                <label for="{{ action_id }}.new-name">New Name</label>
                                <input
                                    id="{{ action_id }}.new-name"
                                    class="new-name-input"
                                    type="text"
                                    name="new_name"
                                    value="{{ action.input_name }}"
                                    autocomplete="off"
                                />
                            {% endif %}

                            {# type independent accept/submit #}
                            <div class="accept-reject-buttons">
                                <button
                                    id="{{ action_id }}.accept"
                                    class="accept-button"
                                    type="submit"
                                    name="accept"
                                    value="true"
                                >Accept</button>
                                <button
                                    id="{{ action_id }}.reject"
                                    class="reject-button"
                                    type="submit"
                                    name="accept"
                                    value="false"
                                >Reject</button>
                            </div>
                        </td>
                    </tr>
                </form>
            {% endfor %}
            </table>
        {% endif %}
    </div>

    <script src="static/wordlist-5-dice-eff.js"></script>
    <script>
        const passwordWordCount = {{ password_word_count or 5 }}

        // setup form validations and user interaction
        for (const form of document.getElementsByClassName('action-form')) {
            const actionId = form.id
            const actionType = form.attributes['action-type'].value
            const acceptButton = document.getElementById(actionId + '.accept')

            if (actionType === 'enable') {
                const passwordInput = document.getElementById(actionId + '.password')
                const showButton = document.getElementById(actionId + '.show')
                const generateButton = document.getElementById(actionId + '.generate')

                if (passwordInput.value.length === 0) passwordInput.value = generatePassword()
                acceptButton.disabled = !isPasswordValid(passwordInput.value)

                generateButton.addEventListener('click', () => {
                    passwordInput.value = generatePassword()
                })
                showButton.addEventListener('click', () => {
                    passwordInput.type = passwordInput.type === 'password' ? 'text' : 'password'
                })
                passwordInput.addEventListener('input', () => {
                    acceptButton.disabled = !isPasswordValid(passwordInput.value)
                })


            } else if (actionType === 'name') {
                const newNameInput = document.getElementById(actionId + '.new-name')
                const conflictName = document.getElementById(actionId + '.name').value
                console.log(conflictName)
                acceptButton.disabled = true
                newNameInput.addEventListener('input', () => {
                    acceptButton.disabled = newNameInput.value.length === 0 || newNameInput.value === conflictName
                })
            }
        }

        function isPasswordValid(password) {
            return password.length > 0
        }

        function generatePassword() {
            let password = ''
            for (let i = 0; i < passwordWordCount; i++) {
                const word = wordlist[Math.floor(Math.random() * wordlist.length)]
                password += word.charAt(0).toUpperCase() + word.substring(1)
            }
            return password
        }

        // from here on is tab sync stuff

        // current state variables
        let unexportedPasswords = 0
        let isActiveTab = true

        // state dependent elements
        const stateLabel = document.getElementById('state')
        const passwordCountLabel = document.getElementById('passwords-count')
        const unexportedLabel = document.getElementById('passwords-unexported')
        const exportLink = document.getElementById('passwords-export')

        // send heartbeat and receive current session state
        async function heartbeat() {
            try {
                const response = await window.fetch('/heartbeat?tag={{ tag }}&tab={{ tab_id }}')
                const state = await response.json()
                unexportedPasswords = state.unexported_passwords
                passwordCountLabel.innerHTML = state.set_passwords
                unexportedLabel.innerHTML = unexportedPasswords > 0 ? `(${unexportedPasswords} unexported)` : ''
                exportLink.className = state.set_passwords > 0 ? '' : 'hidden'
                isActiveTab = state.is_active_tab
                if (!isActiveTab) {
                    stateLabel.innerHTML = 'UI opened in another tab (<a href="/?tag={{ tag }}">continue here</a>)'
                    stateLabel.className = 'warning'
                    removeElementByClassName('active-only')
                }
                if (state.timeout && state.timeout > 0) window.setTimeout(heartbeat, state.timeout)
            } catch (e) {
                // server is not running anymore
                console.error(e)
                isActiveTab = false
                stateLabel.innerHTML = 'interactive import session terminated - you can close this tab now'
                stateLabel.className = 'error'
                removeElementByClassName('running-only')
            }
        }

        function removeElementByClassName(cls) {
            for (const el of Array.from(document.getElementsByClassName(cls))) {
                el.remove()
            }
        }

        heartbeat()
    </script>
</body>
</html>

